---
title: "ST_5_model"
author: "Sean Swift"
date: "February 6, 2020"
output: 
  html_document:
        toc: true
        toc_depth: 4
---

#### Description
ST_model focuses on modeling distributions of particular OTUs across the gradient.
This often requires subsetting by sample type to better understand changes in abundance.
Mostly making linear models. 

TODO: 

  * Try Generalized Additive Models for Location, Scale and Shape (GAMLSS). See   https://bmcbioinformatics.biomedcentral.com/articles/10.1186/s12859-019-2744-2 for comparison between GAMLSS and asin(sqrt())

  * Make lists of significant, abundant, variable otus and investigate them more thoroughly. 

### Pick out variable OTUs
Goal:
'“volcano plot” of -log10(p-value for shore_dist) vs. shore_dist slope or the relative abundance of OTUX to identify a few choice OTUs that are both abundant/change a lot and are highly significant'



```{r setup}
library(mvabund)
library(ggplot2)
library(dplyr)
source("src/make_phyloseq.R")

ST_16S <- readRDS("data/processed/cleaned/ST_16S_spatial.rds")

# make phyloseq
ST_16S_phy <- make_phyloseq(ST_16S)


# get rid of plant shoots
# subset to just include terrestrial samples
# get rid of empty taxa

ST  <- subset_samples(ST_16S_phy, habitat != "Marine")
ST  <- subset_samples(ST, sample_type != "PlantShoot")
ST  <- prune_taxa(taxa_sums(ST) > 0, ST)

# transform to relative abundance
ST_rel <-transform_sample_counts(ST, function(x) x / sum(x) )

```


### Set up the model
To get started, define a function that generates linear models (lm) for each otu.
Currently, the model takes square root transformed abundance data (not relative abundance).


OTUs and values for the independent variable will be pulled from a phyloseq object.
The model coefficients (intercept and slope) and summary coefficients (probablilities, errors, etc.) are stored in a data frame.

Honestly, this is pretty similar to the manylm function in mvabund. Should probably try that too.

```{r model}
# define a function to run linear models, output model coefficients, summary, and relative abundance
get_models <- function(physeq, variable = "shore_dist") {

  # pull out variable from sample data
  shore_dist <- physeq@sam_data[[variable]] %>% as.vector
  
  # pull out otu abundances
  abund <- otu_table(physeq) %>%  as.data.frame()
  
  # apply model to each otu
  probs <- apply(abund, 1, function(x.row) {
          
          # *** MODEL DEFINITION ***
          mod1 <- lm(asin(sqrt(x.row)) ~ shore_dist)
          ####################################
          
          sum1 <- summary(mod1)
          
          append(mod1$coefficients, sum1$coefficients)
          
          }) %>%
          t() %>%
          as.data.frame()
  # set column names for model outputs
  colnames(probs) <-
  c(
  "slope",
  "intercept",
  "int_est",
  "int_err",
  "int_t_value",
  "int_p",
  "slope_estimate",
  "slope_err",
  "slope_t_value",
  "slope_p"
  )
  # add otu names as a column
  probs$otu <- row.names(abund)
  # add otu relative abundance as a column
  probs$rel_abund <- rowSums(abund)/sum(rowSums(abund))
  
  # list otu abundance table and model information
  output <- list(probs,abund)
  names(output) <- c("models","abundance")
  return(output)
}

```

### Linear models : Look for abundant OTUs that change a lot
Having run the model, how many OTUs show up as significantly associated with distance from shore?
How many of those OTUs also vary in their abundance (slope of the linear regression)?
How many of those OTUs are also highly abundant?

To answer these questions, define functions for two types of "volcano" plots:

*1) p-value of OTU vs. variable slope (usually distance from shore)*
*2) p-value of OTU vs. relative abundance of OTU*

Plots include a vertical line at p = 0.001

```{r plots}
# Plot 1
# define a function to plot p value of otu slope vs the actual slope coefficient
plot_pval_vs_slope <- function(got_models, description)
{
  plot(
    -log10(got_models$models$slope_p),
    got_models$models$slope,
    main = paste(description, ": P value shore_dist slope vs. shore_dist slope"),
    xlab = "p value shore_dist slope (-log10)",
    ylab = "shore_dist slope",
    pch = 20,
    col = "darkblue"
    )
  abline(v = -log10(0.001))
}

# Plot 2
# define a function to plot p value of otu slope vs the relative abundance of the OTU
plot_pval_vs_RA <- function(got_models, description, physeq)
{
  plot(
    -log10(got_models$models$slope_p),
    rowSums(got_models$abundance)/sum(rowSums(got_models$abundance)),
    main = paste(description, ": P value shore_dist slope vs. relative abundance"),
    xlab = "p value shore_dist slope (-log10)",
    ylab = "relative abundance of OTU in data",
    pch = 20,
    col = "darkred"
    )
  abline(v=-log10(0.001))
}
```

### Linear models : All samples
Probably, running these models on all samples together will not be very informative, but let's try!

```{r allsamples}

# run linear model on all OTUs across all samples (phyloseq object "ST")
p_all_samples <- get_models(physeq = ST_rel, variable = "shore_dist")

# how many otus have a tiny p value?
length(p_all_samples$models$slope_p[  p_all_samples$models$slope_p < 0.001  ] )

# plot 1
plot_pval_vs_slope(p_all_samples, "Samples")

# plot 2
plot_pval_vs_RA(p_all_samples, "Samples")
```

### lm() : Subset Soil And Sediment Samples
Soil samples were collected at every transect site.
Any good candidate OTUs varying across the gradient?

```{r soil}
# All soil samples

# Subset data to just soil samples
ST_soil <- subset_samples(ST_rel, sample_type %in% c( "SoilShallow","SoilDeep"))
ST_soil <- prune_taxa(taxa_sums(ST_soil) > 0, ST_soil)

# run linear model on all OTUs across all samples (phyloseq object "ST")
p_soil <- get_models(physeq = ST_soil, variable = "shore_dist")
rm(ST_soil)

# how many otus have a tiny p value?
length(p_soil$models$slope_p[  p_soil$models$slope_p < 0.001  ] )

# plot 1
plot_pval_vs_slope(p_soil, "Soil")

# plot 2
plot_pval_vs_RA(p_soil, "Soil")

#####################################

# Shallow Soil Samples

# Subset data to just soil samples
ST_shal_soil <- subset_samples(ST_rel, sample_type %in% c( "SoilShallow"))

# run linear model on all OTUs across all samples (phyloseq object "ST")
p_shal_soil <- get_models(physeq = ST_shal_soil, variable = "shore_dist")

# how many otus have a tiny p value?
length(p_shal_soil$models$slope_p[  p_shal_soil$models$slope_p < 0.001  ] )

# plot 1
plot_pval_vs_slope(p_shal_soil, "Shallow Soil")

# plot 2
plot_pval_vs_RA(p_shal_soil, "Shallow Soil")

#####################################
# Sediment Samples

# Subset data to just soil samples
ST_sed <- subset_samples(ST_rel, sample_type %in% c( "Sediment"))

# run linear model on all OTUs across all samples (phyloseq object "ST")
p_sed <- get_models(physeq = ST_sed, variable = "shore_dist")

# how many otus have a tiny p value?
length(p_sed$models$slope_p[  p_sed$models$slope_p < 0.001  ] )

# plot 1
plot_pval_vs_slope(p_sed, "Sediment")

# plot 2
plot_pval_vs_RA(p_sed, "Sediment")

```

### lm() : Subset Only Water Samples
Water was collected at all transect sites.
Any good candidate OTUs varying across the gradient?

```{r water}
# Subset data to just plant root samples
ST_water <- subset_samples(ST_rel, sample_type %in% c( "WaterNonSaline"))
ST_water <- prune_taxa(taxa_sums(ST_water) > 0, ST_water)

# run linear model on all OTUs across all samples (phyloseq object "ST")
p_water <- get_models(physeq = ST_water, variable = "shore_dist")
rm(ST_water)

# how many otus have a tiny p value?
length(p_water$models$slope_p[  p_water$models$slope_p < 0.001  ] )

# plot 1
plot_pval_vs_slope(p_water, "Water")

# plot 2
plot_pval_vs_RA(p_water, "Water")
```


### lm() : Subset Only Plant Samples
Plant roots were collected at 3 sites per transect.
Any good candidate OTUs varying across the gradient?

```{r plant}
# Subset data to just plant root samples
ST_plant <- subset_samples(ST_rel, sample_type %in% c( "PlantRoot"))
ST_plant <- prune_taxa(taxa_sums(ST_plant) > 0, ST_plant)

# run linear model on all OTUs across all samples (phyloseq object "ST")
p_plant <- get_models(physeq = ST_plant, variable = "shore_dist")
rm(ST_plant)

# how many otus have a tiny p value?
length(p_plant$models$slope_p[  p_plant$models$slope_p < 0.001  ] )

# plot 1
plot_pval_vs_slope(p_plant, "Plant Roots")

# plot 2
plot_pval_vs_RA(p_plant, "Plant Roots")
```

### lm() : Subset Only Mosquito Samples
Mosquitos were collected sort of haphazardly along the transects.
Any good candidate OTUs varying across the gradient?

```{r mosquito}
# Subset data to just mosquito samples
ST_mosquito <- subset_samples(ST_rel, sample_type %in% c( "Mosquito"))
ST_mosquito <- prune_taxa(taxa_sums(ST_mosquito) > 0, ST_mosquito)
# run linear model on all OTUs across all samples (phyloseq object "ST")
p_mosquito <- get_models(physeq = ST_mosquito, variable = "shore_dist")
rm(ST_mosquito)

# how many otus have a tiny p value?
length(p_mosquito$models$slope_p[  p_mosquito$models$slope_p < 0.001  ] )

# plot 1
plot_pval_vs_slope(p_mosquito, "Mosquito")

# plot 2
plot_pval_vs_RA(p_mosquito, "Mosquito")
```


### lm() : Subset Only Drosophila Samples
Drosophila were collected sort of haphazardly across the transects.
Any good candidate OTUs varying across the gradient?

```{r drosophila}
# Subset data to just drosophila samples
ST_drosophila <- subset_samples(ST_rel, sample_type %in% c( "Drosophila"))
ST_drosophila <- prune_taxa(taxa_sums(ST_drosophila) > 0, ST_drosophila)
# run linear model on all OTUs across all samples (phyloseq object "ST")
p_drosophila <- get_models(physeq = ST_drosophila, variable = "shore_dist")
rm(ST_drosophila)

# how many otus have a tiny p value?
length(p_drosophila$models$slope_p[  p_drosophila$models$slope_p < 0.001  ] )

# plot 1
plot_pval_vs_slope(p_drosophila, "Drosophila")

# plot 2
plot_pval_vs_RA(p_drosophila, "Drosophila")
```